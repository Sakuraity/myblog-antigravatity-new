---
// SpotifyEmbed.astro - Spotify 嵌入播放器组件
interface Props {
    url: string;
    compact?: boolean;  // 紧凑模式 (80px 单行播放条)
}

const { url, compact = false } = Astro.props;

// 从 Spotify URL 提取 track/album/playlist ID
function getEmbedUrl(spotifyUrl: string): string {
    try {
        const urlObj = new URL(spotifyUrl);
        
        // 如果已经是 embed URL，直接返回
        if (urlObj.pathname.startsWith('/embed')) {
            return spotifyUrl;
        }

        const pathParts = urlObj.pathname.split('/').filter(Boolean);
        const typeIndex = pathParts.findIndex(part => 
            ['track', 'album', 'playlist', 'artist', 'episode', 'show'].includes(part)
        );

        if (typeIndex !== -1 && pathParts[typeIndex + 1]) {
            const type = pathParts[typeIndex];
            const id = pathParts[typeIndex + 1];
            return `https://open.spotify.com/embed/${type}/${id}?utm_source=generator&theme=0`;
        }
    } catch (e) {
        console.warn('Invalid Spotify URL:', spotifyUrl);
    }
    return spotifyUrl;
}

const embedUrl = getEmbedUrl(url);
// Spotify 官方嵌入高度:
// - compact (单行播放条): 80px  
// - full (带封面标准播放器): 152px
// - large (专辑/播放列表): 352px
const height = compact ? 80 : 152;
---

<div class="spotify-embed-wrapper">
    <iframe 
        src={embedUrl}
        width="100%" 
        height={height}
        allowfullscreen
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
        loading="lazy"
        style="border-radius: 12px; border: 0;"
    ></iframe>
</div>

<style>
    .spotify-embed-wrapper {
        width: 100%;
    }
    .spotify-embed-wrapper iframe {
        display: block;
    }
</style>
