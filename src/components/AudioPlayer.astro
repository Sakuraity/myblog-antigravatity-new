---
// AudioPlayer.astro - 美观的音频播放器组件
interface Props {
    url: string;
    title?: string;
}

const { url, title = "收听本文" } = Astro.props;
---

<div class="audio-player-container">
    <div class="audio-player" data-audio-url={url}>
        <!-- 左侧：播放按钮 -->
        <button class="play-btn" aria-label="播放/暂停">
            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
            </svg>
            <svg class="pause-icon hidden" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
            </svg>
        </button>

        <!-- 中间：信息和进度条 -->
        <div class="audio-content">
            <div class="audio-info">
                <span class="audio-title">{title}</span>
                <span class="audio-time">
                    <span class="current-time">0:00</span>
                    <span class="separator">/</span>
                    <span class="duration">--:--</span>
                </span>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                    <div class="progress-handle"></div>
                </div>
            </div>
        </div>

        <!-- 右侧：音量控制 -->
        <div class="volume-control">
            <button class="volume-btn" aria-label="音量">
                <svg class="volume-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
                <svg class="volume-mute-icon hidden" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
            </button>
            <div class="volume-slider-container">
                <input type="range" class="volume-slider" min="0" max="1" step="0.1" value="1" aria-label="音量控制">
            </div>
        </div>

        <!-- 波形动画 -->
        <div class="audio-wave hidden">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>

<style>
    .audio-player-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 3px;
        max-width: 480px;
        margin: 0 auto;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    }

    .audio-player {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 14px;
        position: relative;
    }

    :global(.dark) .audio-player {
        background: rgba(30, 30, 40, 0.95);
    }

    .play-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s;
        flex-shrink: 0;
    }

    .play-btn:hover {
        transform: scale(1.08);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
    }

    .play-btn:active {
        transform: scale(0.95);
    }

    .play-btn svg {
        width: 24px;
        height: 24px;
    }

    .audio-content {
        flex: 1;
        min-width: 0;
    }

    .audio-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .audio-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    :global(.dark) .audio-title {
        color: #e5e7eb;
    }

    .audio-time {
        font-size: 12px;
        color: #6b7280;
        font-family: monospace;
        flex-shrink: 0;
        margin-left: 8px;
    }

    :global(.dark) .audio-time {
        color: #9ca3af;
    }

    .separator {
        margin: 0 4px;
    }

    .progress-container {
        cursor: pointer;
    }

    .progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        position: relative;
        overflow: visible;
    }

    :global(.dark) .progress-bar {
        background: #374151;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 3px;
        width: 0%;
        transition: width 0.1s linear;
    }

    .progress-handle {
        width: 14px;
        height: 14px;
        background: white;
        border: 2px solid #667eea;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 0%;
        transform: translate(-50%, -50%);
        opacity: 0;
        transition: opacity 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .progress-container:hover .progress-handle {
        opacity: 1;
    }

    .volume-control {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .volume-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s, color 0.2s;
    }

    :global(.dark) .volume-btn {
        color: #9ca3af;
    }

    .volume-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
    }

    .volume-btn svg {
        width: 20px;
        height: 20px;
    }

    .volume-slider-container {
        width: 60px;
        display: none;
    }

    .volume-control:hover .volume-slider-container {
        display: block;
    }

    .volume-slider {
        width: 100%;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: #e5e7eb;
        border-radius: 2px;
        cursor: pointer;
    }

    :global(.dark) .volume-slider {
        background: #374151;
    }

    .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        background: #667eea;
        border-radius: 50%;
        cursor: pointer;
    }

    .volume-slider::-moz-range-thumb {
        width: 12px;
        height: 12px;
        background: #667eea;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }

    /* 波形动画 */
    .audio-wave {
        display: flex;
        align-items: center;
        gap: 3px;
        height: 24px;
        margin-left: 8px;
    }

    .audio-wave span {
        width: 3px;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 2px;
        animation: wave 1s ease-in-out infinite;
    }

    .audio-wave span:nth-child(1) { animation-delay: 0s; }
    .audio-wave span:nth-child(2) { animation-delay: 0.1s; }
    .audio-wave span:nth-child(3) { animation-delay: 0.2s; }
    .audio-wave span:nth-child(4) { animation-delay: 0.3s; }

    @keyframes wave {
        0%, 100% {
            transform: scaleY(0.4);
        }
        50% {
            transform: scaleY(1);
        }
    }

    .hidden {
        display: none !important;
    }

    /* 响应式 */
    @media (max-width: 480px) {
        .audio-player {
            padding: 12px 16px;
            gap: 10px;
        }

        .play-btn {
            width: 40px;
            height: 40px;
        }

        .play-btn svg {
            width: 20px;
            height: 20px;
        }

        .volume-slider-container {
            display: none !important;
        }

        .audio-title {
            font-size: 13px;
        }
    }
</style>

<script>
    document.addEventListener('astro:page-load', () => {
        document.querySelectorAll('.audio-player').forEach(player => {
            if ((player as HTMLElement).dataset.initialized) return;
            (player as HTMLElement).dataset.initialized = 'true';

            const audioUrl = (player as HTMLElement).dataset.audioUrl;
            if (!audioUrl) return;

            const audio = new Audio(audioUrl);
            let isPlaying = false;

            const playBtn = player.querySelector('.play-btn')!;
            const playIcon = player.querySelector('.play-icon') as HTMLElement;
            const pauseIcon = player.querySelector('.pause-icon') as HTMLElement;
            const progressFill = player.querySelector('.progress-fill') as HTMLElement;
            const progressHandle = player.querySelector('.progress-handle') as HTMLElement;
            const progressContainer = player.querySelector('.progress-container')!;
            const currentTimeEl = player.querySelector('.current-time')!;
            const durationEl = player.querySelector('.duration')!;
            const volumeSlider = player.querySelector('.volume-slider') as HTMLInputElement;
            const volumeBtn = player.querySelector('.volume-btn')!;
            const volumeIcon = player.querySelector('.volume-icon') as HTMLElement;
            const volumeMuteIcon = player.querySelector('.volume-mute-icon') as HTMLElement;
            const audioWave = player.querySelector('.audio-wave') as HTMLElement;

            const formatTime = (seconds: number): string => {
                if (isNaN(seconds)) return '--:--';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            // 播放/暂停
            playBtn.addEventListener('click', () => {
                if (isPlaying) {
                    audio.pause();
                } else {
                    audio.play();
                }
            });

            audio.addEventListener('play', () => {
                isPlaying = true;
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                audioWave.classList.remove('hidden');
            });

            audio.addEventListener('pause', () => {
                isPlaying = false;
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioWave.classList.add('hidden');
            });

            // 时间更新
            audio.addEventListener('timeupdate', () => {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressFill.style.width = `${progress}%`;
                progressHandle.style.left = `${progress}%`;
                currentTimeEl.textContent = formatTime(audio.currentTime);
            });

            audio.addEventListener('loadedmetadata', () => {
                durationEl.textContent = formatTime(audio.duration);
            });

            // 进度条点击
            progressContainer.addEventListener('click', (e) => {
                const mouseEvent = e as MouseEvent;
                const rect = (progressContainer as HTMLElement).getBoundingClientRect();
                const percent = (mouseEvent.clientX - rect.left) / rect.width;
                audio.currentTime = percent * audio.duration;
            });

            // 音量控制
            volumeSlider.addEventListener('input', () => {
                const value = parseFloat(volumeSlider.value);
                audio.volume = value;
                updateVolumeIcon(value);
            });

            volumeBtn.addEventListener('click', () => {
                if (audio.volume > 0) {
                    audio.volume = 0;
                    volumeSlider.value = '0';
                } else {
                    audio.volume = 1;
                    volumeSlider.value = '1';
                }
                updateVolumeIcon(audio.volume);
            });

            const updateVolumeIcon = (volume: number) => {
                if (volume === 0) {
                    volumeIcon.classList.add('hidden');
                    volumeMuteIcon.classList.remove('hidden');
                } else {
                    volumeIcon.classList.remove('hidden');
                    volumeMuteIcon.classList.add('hidden');
                }
            };

            // 播放结束
            audio.addEventListener('ended', () => {
                isPlaying = false;
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioWave.classList.add('hidden');
                progressFill.style.width = '0%';
                progressHandle.style.left = '0%';
                currentTimeEl.textContent = '0:00';
            });
        });
    });
</script>
