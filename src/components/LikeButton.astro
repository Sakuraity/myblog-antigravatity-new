---
// LikeButton.astro - 点赞按钮组件
// 居中圆形大拇指图标样式
// 使用 LocalStorage 记录用户点赞状态

interface Props {
    id: string;           // 内容唯一标识
    type: 'post' | 'note'; // 内容类型
}

const { id, type } = Astro.props;
const storageKey = `like_${type}_${id}`;
const cfWorkerUrl = import.meta.env.PUBLIC_CF_WORKER_URL || '';
---

<div class="like-container flex flex-col items-center justify-center py-6 gap-2">
    <button 
        class="like-button w-14 h-14 rounded-full border-2 border-primary/50 hover:border-primary flex items-center justify-center transition-all duration-300 hover:scale-105 active:scale-95 text-primary/60 hover:text-primary relative"
        data-id={id}
        data-type={type}
        data-storage-key={storageKey}
        data-cf-url={cfWorkerUrl}
        aria-label="点赞"
    >
        <!-- 空心大拇指 (未点赞) -->
        <svg 
            class="like-icon-empty w-6 h-6 transition-all duration-200"
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
            stroke-width="1.5"
        >
            <path 
                stroke-linecap="round" 
                stroke-linejoin="round" 
                d="M6.633 10.25c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75a.75.75 0 0 1 .75-.75 2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282m0 0h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H5.904m7.723-9.155V6M5.904 18.5c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 0 1-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 9.953 4.167 9.5 5 9.5h1.053c.472 0 .745.556.5.96a8.958 8.958 0 0 0-1.302 4.665c0 1.194.232 2.333.654 3.375Z"
            />
        </svg>
        
        <!-- 实心大拇指 (已点赞) -->
        <svg 
            class="like-icon-filled w-6 h-6 hidden text-primary"
            fill="currentColor" 
            viewBox="0 0 24 24"
        >
            <path d="M7.493 18.75c-.425 0-.82-.236-.975-.632A7.48 7.48 0 0 1 6 15.375c0-1.75.599-3.358 1.602-4.634.151-.192.373-.309.6-.397.473-.183 1.016-.062 1.349.312l.383.426c.478.533.113 1.357-.604 1.469a4.957 4.957 0 0 0-1.08.336c-.02.005-.039.01-.058.014v.002l-.057.012-.002.001-.072.016-.001.001a5.018 5.018 0 0 0-.206.064c.213.718.596 1.368 1.1 1.913.167.18.166.467-.024.627a.537.537 0 0 1-.358.136h-.162c-.355 0-.65-.287-.75-.632a7.441 7.441 0 0 1-.35-2.248c0-.26.013-.517.04-.772a.495.495 0 0 1 .492-.447h.25c.305 0 .548.25.495.554a5.96 5.96 0 0 0-.033.722c0 .49.058.965.168 1.419.041.169.015.35-.064.504l-.07.137c-.09.174-.276.286-.476.286h-.064Zm7.83-12.108a.87.87 0 0 1-.006.01l-.002.002a8.961 8.961 0 0 1-1.72 2.024c-.672.56-1.484 1.04-2.36 1.391l.002.001a.743.743 0 0 1-.258.046h-.001a.758.758 0 0 1-.69-.463 3.55 3.55 0 0 1-.24-1.304v-.368c0-.092 0-.183.006-.274a.758.758 0 0 1 .757-.704l.033.001c.358.008.713.055 1.059.14.31.077.623.178.929.303a7.465 7.465 0 0 0 1.976-1.675c.225-.28.426-.577.6-.89a.75.75 0 0 1 1.29.002 3.743 3.743 0 0 1 .627 2.083c0 .41.336.746.747.746h2.485c.843 0 1.584.567 1.69 1.4.062.47.093.95.093 1.435 0 2.58-.86 4.96-2.31 6.868a2.25 2.25 0 0 1-1.794.897H13.48a2.247 2.247 0 0 1-.71-.115l-3.114-1.04a2.997 2.997 0 0 0-.95-.154H7.493Z" />
        </svg>
    </button>
    <!-- 点赞数显示 -->
    <span class="like-count text-xs font-medium text-text-muted-light dark:text-text-muted-dark tabular-nums"></span>
</div>

<script>
    function initLikeButtons() {
        const buttons = document.querySelectorAll('.like-button');
        
        buttons.forEach(button => {
            const storageKey = (button as HTMLElement).dataset.storageKey!;
            const id = (button as HTMLElement).dataset.id!;
            const type = (button as HTMLElement).dataset.type!;
            const emptyIcon = button.querySelector('.like-icon-empty') as HTMLElement;
            const filledIcon = button.querySelector('.like-icon-filled') as HTMLElement;
            const countDisplay = button.parentElement?.querySelector('.like-count') as HTMLElement;
            
            // 内部状态跟踪
            let currentCount = 0;
            let isLiked = localStorage.getItem(storageKey) === 'true';
            updateUI(isLiked);
            fetchCount();
            
            async function fetchCount() {
                try {
                    const cfUrl = (button as HTMLElement).dataset.cfUrl;
                    const fetchUrl = cfUrl 
                        ? `${cfUrl.replace(/\/$/, '')}/stats/${id}`
                        : `/api/like?id=${id}`;
                    
                    const res = await fetch(fetchUrl);
                    const data = await res.json();
                    if (data && typeof data.count === 'number') {
                        currentCount = data.count;
                        updateCountUI(currentCount);
                    }
                } catch (err) {
                    console.debug('Fetch count failed:', err);
                }
            }

            function updateCountUI(count: number) {
                if (countDisplay) {
                    countDisplay.textContent = count > 0 ? `${count} 人觉得很赞` : '';
                }
            }

            function updateUI(liked: boolean) {
                if (liked) {
                    emptyIcon.classList.add('hidden');
                    filledIcon.classList.remove('hidden');
                    button.classList.add('border-primary', 'bg-primary/10');
                    button.classList.remove('border-primary/50');
                } else {
                    emptyIcon.classList.remove('hidden');
                    filledIcon.classList.add('hidden');
                    button.classList.remove('border-primary', 'bg-primary/10');
                    button.classList.add('border-primary/50');
                }
            }
            
            // 动画
            function animateLike() {
                button.classList.add('animate-like');
                setTimeout(() => {
                    button.classList.remove('animate-like');
                }, 400);
            }
            
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const wasLiked = localStorage.getItem(storageKey) === 'true';
                const cfUrl = (button as HTMLElement).dataset.cfUrl;
                
                if (wasLiked) {
                    // 取消点赞
                    localStorage.removeItem(storageKey);
                    updateUI(false);
                    // 前端计数减一（但不低于 0）
                    currentCount = Math.max(0, currentCount - 1);
                    updateCountUI(currentCount);
                } else {
                    // 点赞
                    localStorage.setItem(storageKey, 'true');
                    updateUI(true);
                    animateLike();
                    
                    // 乐观更新计数
                    currentCount += 1;
                    updateCountUI(currentCount);
                    
                    // 静默调用 API
                    try {
                        const apiUrl = cfUrl 
                            ? `${cfUrl.replace(/\/$/, '')}/like/${id}`
                            : '/api/like';
                        
                        const fetchOptions: RequestInit = cfUrl 
                            ? { method: 'POST' } 
                            : { 
                                method: 'POST', 
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id, type })
                            };

                        const res = await fetch(apiUrl, fetchOptions);
                        const data = await res.json();
                        // 如果后端返回了精确的最新计数，同步一下
                        if (data && typeof data.count === 'number') {
                            currentCount = data.count;
                            updateCountUI(currentCount);
                        }
                    } catch (err) {
                        console.debug('Like API call failed:', err);
                    }
                }
            });
        });
    }
    
    document.addEventListener('astro:page-load', initLikeButtons);
</script>

<style>
    @keyframes like-pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }
    
    .animate-like {
        animation: like-pop 0.4s ease-in-out;
    }
</style>
