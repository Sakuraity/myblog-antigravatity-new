---
// LikeButton.astro - 点赞按钮组件
// 只显示点赞状态（空心/实心），不显示数量
// 使用 LocalStorage 记录用户点赞状态，同时调用 API 记录统计

interface Props {
    id: string;           // 内容唯一标识（如 post slug 或 note slug）
    type: 'post' | 'note'; // 内容类型
}

const { id, type } = Astro.props;
const storageKey = `like_${type}_${id}`;
---

<button 
    class="like-button group flex items-center gap-1.5 text-text-muted-light dark:text-text-muted-dark hover:text-red-500 dark:hover:text-red-400 transition-colors duration-200"
    data-id={id}
    data-type={type}
    data-storage-key={storageKey}
    aria-label="点赞"
>
    <!-- 空心爱心 (未点赞) -->
    <svg 
        class="like-icon-empty w-5 h-5 transition-transform duration-200 group-hover:scale-110"
        fill="none" 
        stroke="currentColor" 
        viewBox="0 0 24 24"
    >
        <path 
            stroke-linecap="round" 
            stroke-linejoin="round" 
            stroke-width="1.5" 
            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
        />
    </svg>
    
    <!-- 实心爱心 (已点赞) -->
    <svg 
        class="like-icon-filled w-5 h-5 hidden text-red-500"
        fill="currentColor" 
        viewBox="0 0 24 24"
    >
        <path 
            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
        />
    </svg>
</button>

<script>
    function initLikeButtons() {
        const buttons = document.querySelectorAll('.like-button');
        
        buttons.forEach(button => {
            const storageKey = (button as HTMLElement).dataset.storageKey!;
            const id = (button as HTMLElement).dataset.id!;
            const type = (button as HTMLElement).dataset.type!;
            const emptyIcon = button.querySelector('.like-icon-empty') as HTMLElement;
            const filledIcon = button.querySelector('.like-icon-filled') as HTMLElement;
            
            // 检查是否已点赞
            const isLiked = localStorage.getItem(storageKey) === 'true';
            updateUI(isLiked);
            
            function updateUI(liked: boolean) {
                if (liked) {
                    emptyIcon.classList.add('hidden');
                    filledIcon.classList.remove('hidden');
                } else {
                    emptyIcon.classList.remove('hidden');
                    filledIcon.classList.add('hidden');
                }
            }
            
            // 心跳动画
            function heartbeat() {
                filledIcon.classList.add('animate-heartbeat');
                setTimeout(() => {
                    filledIcon.classList.remove('animate-heartbeat');
                }, 300);
            }
            
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const wasLiked = localStorage.getItem(storageKey) === 'true';
                
                if (wasLiked) {
                    // 取消点赞
                    localStorage.removeItem(storageKey);
                    updateUI(false);
                } else {
                    // 点赞
                    localStorage.setItem(storageKey, 'true');
                    updateUI(true);
                    heartbeat();
                    
                    // 调用 API 记录统计（静默失败，不影响用户体验）
                    try {
                        await fetch('/api/like', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id, type })
                        });
                    } catch (err) {
                        // 静默处理，不影响用户体验
                        console.debug('Like API call failed:', err);
                    }
                }
            });
        });
    }
    
    // 初始化
    document.addEventListener('astro:page-load', initLikeButtons);
</script>

<style>
    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }
    
    .animate-heartbeat {
        animation: heartbeat 0.3s ease-in-out;
    }
    
    .like-button:active .like-icon-filled,
    .like-button:active .like-icon-empty {
        transform: scale(0.9);
    }
</style>
