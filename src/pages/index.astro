---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
).slice(0, 5);

const notesRaw = (await getCollection('notes')).sort(
    (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
).slice(0, 4);



const notes = await Promise.all(notesRaw.map(async (note) => {
    const { Content } = await note.render();
    return { note, Content };
}));

const libraryItems = (await getCollection('library')).sort(
    (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
).slice(0, 5);

import NoteCard from '../components/NoteCard.astro';
import LibraryCard from '../components/LibraryCard.astro';
import StrangerThingsCountdown from '../components/StrangerThingsCountdown.astro';
---

<Layout title="Kangyuan's Blog">
	<!-- Hero Section -->
	<section class="py-20 md:py-32 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
		<div class="flex flex-col">
			<h1 class="font-serif text-5xl md:text-7xl font-bold mb-8 text-text-light dark:text-text-dark tracking-tight leading-none">
				Hammer Seeking Nail: <br/> <span class="text-primary/90">Logic · Emotion · Elegance</span>
			</h1>
			<p class="text-xl md:text-2xl text-text-muted-light dark:text-text-muted-dark max-w-2xl leading-relaxed italic font-serif">
				安放思考，自由表达，分享创造
			</p>
		</div>
		
		<div class="w-full max-w-lg mx-auto lg:ml-auto transform rotate-1 hover:rotate-0 transition-transform duration-500">
			<!-- Stranger Things Season 5 Countdown -->
			<StrangerThingsCountdown />
		</div>
	</section>

	<hr class="border-black/5 dark:border-white/10 mb-16" />

	<div class="space-y-24">
		<!-- Blog & Notes Grid -->
		<section class="grid grid-cols-1 lg:grid-cols-12 gap-12">
			<!-- Blog Column (Left) -->
			<div class="lg:col-span-8 flex flex-col gap-12">
				<div class="flex items-center justify-between border-b border-black/5 dark:border-white/10 pb-4">
					<h2 class="font-serif text-2xl font-bold text-text-light dark:text-text-dark">Essays</h2>
					<a href="/blog" class="group flex items-center gap-1 text-sm font-medium text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors">
						View all 
						<span class="group-hover:translate-x-1 transition-transform">&rarr;</span>
					</a>
				</div>
				
				<div class="flex flex-col gap-10">
					{posts.map((post) => (
						<article class="group relative grid grid-cols-1 md:grid-cols-4 gap-6 items-baseline">
							<div class="md:col-span-1 text-sm font-medium text-text-muted-light dark:text-text-muted-dark font-sans">
								<time datetime={post.data.pubDate.toISOString()}>
									{post.data.pubDate.toLocaleDateString('zh-CN', {
										year: 'numeric',
										month: 'long',
										day: 'numeric',
									})}
								</time>
							</div>
							
							<div class="md:col-span-3 flex flex-col space-y-2">
								<h3 class="text-xl font-serif font-bold leading-tight text-text-light dark:text-text-dark group-hover:text-primary transition-colors duration-200">
									<a href={`/posts/${post.slug}/`}>
										<span class="absolute inset-0"></span>
										{post.data.title}
									</a>
								</h3>
								<p class="text-sm text-text-muted-light dark:text-text-muted-dark leading-relaxed line-clamp-2">
									{post.data.description}
								</p>
								<div class="flex items-center gap-3 pt-1">
                                    {post.data.category && (
                                        <span class="text-xs font-medium uppercase tracking-widest text-primary">{post.data.category}</span>
                                    )}
									{post.data.tags && post.data.tags.length > 0 && (
										<div class="flex flex-wrap gap-2 relative z-10">
											{post.data.tags.slice(0, 3).map(tag => (
												<a href={`/tags/${tag}`} class="text-xs font-medium text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors">
													#{tag}
												</a>
											))}
										</div>
									)}
								</div>
							</div>
						</article>
					))}
				</div>
			</div>

			<!-- Notes Column (Right) -->
			<div class="lg:col-span-4 flex flex-col gap-8">
				<div class="flex items-center justify-between border-b border-black/5 dark:border-white/10 pb-4">
					<h2 class="font-serif text-2xl font-bold text-text-light dark:text-text-dark">Notes</h2>
					<a href="/notes" class="group flex items-center gap-1 text-sm font-medium text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors">
						View all 
						<span class="group-hover:translate-x-1 transition-transform">&rarr;</span>
					</a>
				</div>

				<div class="space-y-6">
					{notes.map(({ note, Content }) => (
						<NoteCard 
							date={note.data.date}
							tags={note.data.tags}
                            truncate={true}
						>
                            <Content />
                        </NoteCard>
					))}
                    {notes.length === 0 && (
                        <p class="text-text-muted-light dark:text-text-muted-dark text-sm italic">No notes yet.</p>
                    )}
				</div>
			</div>
		</section>

		<!-- Library Section -->
		<section>
			<div class="flex items-center justify-between border-b border-black/5 dark:border-white/10 pb-4 mb-8">
				<h2 class="font-serif text-2xl font-bold text-text-light dark:text-text-dark">Library</h2>
				<a href="/library" class="group flex items-center gap-1 text-sm font-medium text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors">
					View all 
					<span class="group-hover:translate-x-1 transition-transform">&rarr;</span>
				</a>
			</div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
                {libraryItems.map(item => (
                    <LibraryCard 
                        type={item.data.type}
                        title={item.data.title}
                        artist={item.data.artist}
                        spotifyUrl={item.data.spotifyUrl}
                        source={item.data.source}
                        videoId={item.data.videoId}
                        author={item.data.author}
                        status={item.data.status}
                        rating={item.data.rating}
                        link={item.data.link}
                        comment={item.data.comment}
                        date={item.data.date}
                        coverImage={item.data.coverImage}
                        hidePlayer={true}
                    />
                ))}
                 {libraryItems.length === 0 && (
                    <div class="col-span-full text-center text-text-muted-light dark:text-text-muted-dark text-sm italic">
                        No library items yet.
                    </div>
                )}
            </div>
		</section>
	</div>
</Layout>
