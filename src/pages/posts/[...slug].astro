---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import AudioPlayer from '../../components/AudioPlayer.astro';
import LikeButton from '../../components/LikeButton.astro';

export async function getStaticPaths() {
	const posts = await getCollection('posts');
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: post,
	}));
}

const post = Astro.props;
const { Content } = await post.render();

// Simply get 3 recent posts as related articles for now
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
	.filter((p) => p.slug !== post.slug)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3);
---

<Layout title={post.data.title}>
	<article class="py-12 md:py-20">
		<!-- Header -->
		<div class="max-w-[728px] mx-auto px-6 mb-16 md:mb-20 text-center">
			<div class="flex items-center justify-center gap-2 text-xs font-medium uppercase tracking-widest text-text-muted-light dark:text-text-muted-dark mb-6">
				<span>{post.data.category || 'Essay'}</span>
			</div>
			<h1 class="text-[2.5rem] leading-[1.2] font-serif font-medium text-text-light dark:text-text-dark mb-8">
				{post.data.title}
			</h1>
			
			<!-- Decorative Divider -->
			<div class="w-10 h-px bg-gray-300 dark:bg-gray-700 mx-auto mb-8"></div>

			<div class="flex items-center justify-center gap-4 text-sm text-text-muted-light dark:text-text-muted-dark font-light">
				<time datetime={post.data.pubDate.toISOString()}>
					{post.data.pubDate.toLocaleDateString('zh-CN', {
						year: 'numeric',
						month: 'long',
						day: 'numeric',
					})}
				</time>
				<span>&middot;</span>
				<span>{Math.ceil(post.body.length / 500)} min read</span>
			</div>
		</div>

		<!-- Hero Image -->
		{post.data.heroImage && (
			<div class="max-w-[800px] mx-auto h-[300px] md:h-[500px] bg-gray-100 dark:bg-gray-800 mb-16 overflow-hidden rounded-sm">
				<Image 
					src={post.data.heroImage} 
					alt={post.data.title} 
					class="w-full h-full object-cover" 
					width={1200}
					height={675}
				/>
			</div>
		)}

		<!-- Audio Player -->
		{post.data.audioUrl && (
			<div class="max-w-[728px] mx-auto px-6 mb-12">
				<AudioPlayer url={post.data.audioUrl} title="收听本文" />
			</div>
		)}

		<!-- Content -->
		<div class="max-w-[728px] mx-auto px-6">
			<div class="prose prose-lg dark:prose-invert max-w-none prose-p:font-sans prose-p:text-[19px] prose-p:leading-[1.6] prose-p:text-[#363737] dark:prose-p:text-[#e0e0e0] prose-headings:font-serif prose-headings:font-normal prose-a:text-primary hover:prose-a:text-primary/80 prose-img:rounded-lg prose-p:mb-5">
				{post.data.description && (
					<>
						<p class="text-xl leading-relaxed font-serif text-text-light/90 dark:text-text-dark/90 italic mb-12 text-center">
							{post.data.description}
						</p>
						<hr class="w-24 border-t border-black/10 dark:border-white/10 my-12 mx-auto" />
					</>
				)}
				<Content />
			</div>
			
			<!-- 点赞按钮 -->
			<div class="mt-16 pt-8 border-t border-black/5 dark:border-white/10 flex justify-center">
				<LikeButton id={post.slug} type="post" />
			</div>
		</div>
	</article>

	<!-- Related Articles -->
	<div class="border-t border-black/5 dark:border-white/10 mt-12 py-16 bg-bg-light/50 dark:bg-bg-dark/50">
		<div class="max-w-2xl mx-auto px-6">
			<h3 class="font-serif text-xl mb-8 text-text-light dark:text-text-dark">相关文章</h3>
			<div class="space-y-8">
				{relatedPosts.map((p) => (
					<a href={`/posts/${p.slug}`} class="block group">
						<div class="flex items-start justify-between gap-4">
							<div>
								<h4 class="font-serif text-lg font-medium group-hover:text-primary transition-colors text-text-light dark:text-text-dark">
									{p.data.title}
								</h4>
								<p class="text-sm text-text-muted-light dark:text-text-muted-dark mt-2 line-clamp-2 font-light">
									{p.data.description}
								</p>
								<time class="text-xs text-text-muted-light/60 dark:text-text-muted-dark/60 mt-3 block uppercase tracking-wider">
									{p.data.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
								</time>
							</div>
						</div>
					</a>
				))}
			</div>
		</div>
	</div>
</Layout>
