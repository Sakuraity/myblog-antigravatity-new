# Learned Lessons

## 2025

- [2025-12-17] **配置生成安全**: 程序化生成 YAML/JSON 配置文件时，必须对动态内容中的特殊字符（尤其是引号）进行转义，防止语法破坏导致构建失败。
- [2025-12-17] **防御性数据处理**: 处理可选的数组数据（如 CMS 内容标签）时，始终提供默认值（如 `|| []`）以防止 `undefined` 导致的运行时或构建错误。
- [2025-12-17] **Library 音乐添加 SOP**: 用户指令为“添加音乐，[Link]”时执行以下流程：1. 抓取 URL 的 meta 信息（标题、歌手、OG 封面图）；2. 在 `src/content/library/` 创建文件；3. `spotifyUrl` 填入原始链接，`coverImage` 填入抓取到的封面图 URL，`comment` 填入一句话简介。组件会自动处理显示逻辑。
- [2025-12-17] **音乐封面图源规范**: 避免直接使用第三方 CDN (如 YouTube/Spotify) 链接作为 `coverImage`，因存在 404 或防盗链风险。必须将封面图**下载保存至本地** (`public/images/library-covers/`)，并在 content 文件中引用本地路径。
- [2025-12-17] **Content Schema 兼容性**: 在 `config.ts` 定义图片字段时，若需支持本地路径，不可仅使用 `z.string().url()`（会报错 `Invalid url`）。必须放宽为 `z.string()` 或使用 `z.union([image(), z.string()])` 以兼容本地相对/绝对路径。
- [2025-12-17] **File Naming Safety**: 严禁在文件或目录名中使用 URL 保留字符（如 `#`, `?`, `&`），这将导致 Vite/Rollup 模块解析失败（Error: `Rollup failed to resolve import`）。Content Collection 的文件命名应保持简洁，仅包含字母、数字、中文、连字符或下划线。
- [2025-12-18] **Astro View Transitions 脚本兼容性**: 使用 `ViewTransitions` 时，`DOMContentLoaded` 事件不会在软导航后触发。需使用 `astro:page-load`（每次新页面可见时）和 `astro:after-swap`（DOM 替换后立即执行）来确保脚本正确重新执行。主题初始化等防闪烁逻辑应放在 `<head>` 使用 `is:inline` 标记，并监听 `astro:after-swap` 以保持跨页状态。
- [2025-12-18] **View Transitions 事件监听器内存泄漏**: 在 `astro:page-load` 回调中直接添加事件监听器会导致每次导航都重复添加。解决方案：使用 `element.dataset.initialized` 标记防止重复绑定，或在添加新监听器前先移除旧监听器。
- [2025-12-18] **Astro 静默启动失败诊断**: 当 `npm run dev` 执行后终端无任何输出、服务器无法访问时，通常是 `node_modules` 损坏（如部分依赖包安装不完整，缺少 `transform-ast.js` 等文件）。诊断方法：1) 检查进程是否存在 (`ps aux | grep astro`)；2) 检查端口是否监听 (`lsof -i :4321`)。若进程存在但端口未监听，基本可确认依赖损坏。
- [2025-12-18] **node_modules 损坏修复 SOP**: 遇到 Node.js 项目依赖问题（模块缺失、版本冲突、静默失败），优先使用 `rm -rf node_modules && npm install` 完全重建依赖树，而非尝试单独修复。此操作可解决大多数由依赖损坏引起的构建/启动问题。
- [2025-12-18] **Astro Content Frontmatter 自定义字段**: 在 content collection 中添加可选字段（如 `audioUrl`）时，需同步更新三处：1) `config.ts` schema 添加字段定义；2) 内容生成/导入脚本支持提取和写入该字段；3) 页面模板条件渲染对应组件。使用 `z.string().url().optional()` 定义可选 URL 字段。
- [2025-12-18] **HTML5 Audio 播放器开发**: 创建自定义音频播放器时，使用 `new Audio(url)` 创建音频对象，通过监听 `play`、`pause`、`timeupdate`、`loadedmetadata`、`ended` 事件更新 UI。进度条点击事件需计算点击位置百分比并设置 `audio.currentTime = percent * audio.duration`。
- [2025-12-18] **Astro 自动生成类型维护**: `.astro/` 目录存放 Astro 自动生成的 TS 类型文件（如 `content.d.ts`）。如果遇到内容集合类型丢失、文件被清空或不一致，可运行 `npx astro sync` 强制刷新。为避免 Git 提交干扰，建议在 `.gitignore` 中忽略 `.astro/`（除非团队明确要求同步类型定义）。
- [2025-12-18] **嵌套交互元素层级**: 当父容器是一个大链接（如使用 absolute inset-0 覆盖的卡片）时，内部的交互元素（如标签链接、按钮）必须设置 `relative` 和较高的 `z-index`（如 `z-10`），否则点击事件会被父容器的遮罩层捕获，导致内部链接失效。
- [2025-12-18] **TypeScript in Astro Scripts**: Astro 组件内的 `<script>` 标签若使用 TypeScript (默认启用)，必须为所有函数参数提供明确的类型注解（如 `(id: string, value: number)`），否则会因 `noImplicitAny` 规则导致构建报错 `Parameter implicitly has an 'any' type`。构建流程比 `npm run dev` 更严格，开发时应留意类型完整性。

