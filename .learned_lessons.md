# Learned Lessons

## 2025

---

### 🛡️ 文件与配置安全

- [2025-12-17] **静态资源与配置的命名/生成安全**: 
  1. 程序化生成 YAML/JSON 配置文件时，必须对动态内容中的特殊字符（尤其是引号）进行转义，防止语法破坏导致构建失败。
  2. 严禁在文件或目录名中使用 URL 保留字符（如 `#`, `?`, `&`），这将导致 Vite/Rollup 模块解析失败（Error: `Rollup failed to resolve import`）。Content Collection 的文件命名应保持简洁，仅包含字母、数字、中文、连字符或下划线。

- [2025-12-17] **防御性数据处理**: 处理可选的数组数据（如 CMS 内容标签）时，始终提供默认值（如 `|| []`）以防止 `undefined` 导致的运行时或构建错误。

---

### 📚 Astro Content Collection

- [2025-12-17] **Content Schema 定义规范**:
  1. 在 `config.ts` 定义图片字段时，若需支持本地路径，不可仅使用 `z.string().url()`（会报错 `Invalid url`）。必须放宽为 `z.string()` 或使用 `z.union([image(), z.string()])` 以兼容本地相对/绝对路径。
  2. 当使用 `image()` 等 helper 时，必须将 `schema` 定义为接收 context 的函数形式 `schema: ({ image }) => z.object({...})`，而非直接传入 `z.object`，否则会报错 helper 未定义。
  3. 使用 `z.string().url().optional()` 定义可选 URL 字段。

- [2025-12-19] **Content 数据使用规范**:
  1. 在 content collection 中添加可选字段（如 `audioUrl`）时，需同步更新三处：`config.ts` schema 添加字段定义、内容生成/导入脚本支持提取和写入该字段、页面模板条件渲染对应组件。
  2. `getCollection` 返回的 `entry.body` 仅为 Markdown 源码字符串。若需渲染富文本（HTML、图片、组件），必须使用 `{ Content } = await entry.render()` 并渲染 `<Content />` 组件，而不能简单地 `set:html={entry.body}`。

---

### 🔄 Astro View Transitions

- [2025-12-18] **View Transitions 开发规范**:
  1. **生命周期事件**: 使用 `ViewTransitions` 时，`DOMContentLoaded` 事件不会在软导航后触发。需使用 `astro:page-load`（每次新页面可见时）和 `astro:after-swap`（DOM 替换后立即执行）来确保脚本正确重新执行。
  2. **主题/状态持久化**: 主题初始化等防闪烁逻辑应放在 `<head>` 使用 `is:inline` 标记，并监听 `astro:after-swap` 以保持跨页状态。
  3. **防止内存泄漏**: 在 `astro:page-load` 回调中直接添加事件监听器会导致每次导航都重复添加。解决方案：使用 `element.dataset.initialized` 标记防止重复绑定，或在添加新监听器前先移除旧监听器。

---

### 🔍 Pagefind 搜索集成

- [2025-12-19] **Pagefind UI Customization**: 使用 Pagefind 默认 UI 时，可通过 CSS 变量 (`--pagefind-ui-primary`, etc.) 进行深度定制。若需更激进的修改（如移除图标、缩略图），可使用 `!important` 覆盖 CSS 类，或隐藏特定元素 (`display: none`)。要实现 Modal 交互，可将 Pagefind 容器置于 `<dialog>` 中，封装 `open`/`close` 方法并绑定键盘快捷键 (`Cmd+K`)。

- [2025-12-19] **Astro Pagefind Indexing Scope**: Pagefind 默认尝试索引 `data-pagefind-body` 元素。若未找到，会降级索引整个 `<body>` 并发出构建警告。在主内容区域（如 `<main>`）显式添加 `data-pagefind-body` 属性可消除警告并提高搜索结果的相关性，避免索引页脚或导航栏无关内容。

---

### 🎨 CSS 与样式技巧

- [2025-12-19] **CSS Mimicry for Branded Typography**: When implementing branded aesthetics (e.g., Stranger Things) without access to proprietary fonts, use CSS `text-shadow` layers and `-webkit-text-stroke` on standard serif fonts to mimic the visual style. Isolate these heavy styles in specific components.

- [2025-12-19] **CSS Variable Staggering**: When creating complex animations for a collection of elements (e.g., blinking lights for an alphabet wall), use inline styles to set a CSS variable for the index and use `calc()` in the CSS animation delay. This keeps the JS clean.

---

### 🖱️ UX 交互模式

- [2025-12-19] **列表项展开交互模式 (Accordion + Focus)**:
  1. **手风琴与自动滚动**: 在实现长列表（如笔记/文章预览）的"展开/收起"手风琴交互时，务必配合 `scrollIntoView({ behavior: 'smooth', block: 'start' })`。因为收起其他卡片会导致页面高度骤变，使用户迷失焦点。利用 `setTimeout` 稍微延迟滚动以等待 CSS 布局变化稳定，并为目标容器设置 `scroll-margin-top` 以适应 Sticky Header。
  2. **Dim Others Focus**: 避免使用突兀的高亮动画（如 glowing border）。采用"其他项变暗 (Dim Others)"的模式（即给容器添加状态类，降低非 active 项的 opacity）能提供更沉浸、高级的阅读体验，且通过 CSS `transition` 实现平滑过渡，视觉干扰最小。

- [2025-12-19] **Conditional UI Truncation**: 实现"阅读更多"截断功能时，若依赖静态 CSS (`max-height`)，可能导致短内容下方仍显示截断遮罩和按钮。应在客户端使用 JS 比较 `scrollHeight > clientHeight`，仅在确实溢出时显示交互组件，确保 UI 的整洁与合理性。

- [2025-12-18] **嵌套交互元素层级**: 当父容器是一个大链接（如使用 absolute inset-0 覆盖的卡片）时，内部的交互元素（如标签链接、按钮）必须设置 `relative` 和较高的 `z-index`（如 `z-10`），否则点击事件会被父容器的遮罩层捕获，导致内部链接失效。

---

### 🎵 媒体组件开发

- [2025-12-18] **HTML5 Audio 播放器开发**: 创建自定义音频播放器时，使用 `new Audio(url)` 创建音频对象，通过监听 `play`、`pause`、`timeupdate`、`loadedmetadata`、`ended` 事件更新 UI。进度条点击事件需计算点击位置百分比并设置 `audio.currentTime = percent * audio.duration`。

---

### ⚙️ TypeScript 与构建

- [2025-12-18] **TypeScript in Astro Scripts**: Astro 组件内的 `<script>` 标签若使用 TypeScript (默认启用)，必须为所有函数参数提供明确的类型注解（如 `(id: string, value: number)`），否则会因 `noImplicitAny` 规则导致构建报错 `Parameter implicitly has an 'any' type`。构建流程比 `npm run dev` 更严格，开发时应留意类型完整性。

- [2025-12-18] **Astro 自动生成类型维护**: `.astro/` 目录存放 Astro 自动生成的 TS 类型文件（如 `content.d.ts`）。如果遇到内容集合类型丢失、文件被清空或不一致，可运行 `npx astro sync` 强制刷新。为避免 Git 提交干扰，建议在 `.gitignore` 中忽略 `.astro/`（除非团队明确要求同步类型定义）。

---

### 🍎 macOS Automation

- [2025-12-18] **macOS Automation 开发技巧**:
  1. **避免硬编码路径**: When creating macOS automations or apps (like `.app` bundles wrapping scripts), avoid hardcoding absolute paths (e.g., `/Users/username/Docs/...`). Use dynamic path resolution (e.g., `POSIX path of (path to me)`) or environment variables to ensure the app works across different machines or directory structures.
  2. **Applet 反编译与重建**: Use `osadecompile` to read the source of a compiled AppleScript `.app` (specifically `Contents/Resources/Scripts/main.scpt`). Use `osacompile` to rebuild it to fix binary issues or update logic.

---

### 🔧 脚本与环境

- [2025-12-18] **Environment Variables in Standalone Scripts**: When running standalone Node.js scripts (e.g., `node scripts/task.mjs`) that depend on `.env` files, verify if the script uses `dotenv` or relies on the shell/caller to load variables. If verified via `node`, ensure you export the variables first (e.g., `export $(cat .env | xargs)`) to avoid false negatives where the script works in the full pipeline (which sources .env) but fails in isolation.

---

### 🤖 自动化与内容提取

- [2025-12-22] **基于 Browser Agent 的社交媒体提取**: 在实现即刻 (Jike) 等动态页面的自动化笔记提取时，直接使用 `read_url_content` 往往无法获取由 JS 渲染的内容。应使用 `browser_subagent` 导航并显式执行 JS 来提取 DOM 数据（如下标为 `img` 的 `src`）。生成的 Markdown 应使用标准 `![image](url)` 语法以保证在 Content Collection 渲染时的跨平台兼容性。

- [2025-12-29] **DOM 提取的特异性策略**: 在提取类名混淆（如 `jk-18tsg9e`）的社交媒体内容时，避免依赖不稳定的 CSS 类选择器。更稳健的策略是利用 DOM 结构关系（如定位已知元素如头像的父容器）或特定的语义文本标记（Text Markers）来定位核心内容。

- [2025-12-29] **Astro Content Collection 路由命名**: 当使用文件系统路由（`pages/posts/[...slug].astro`）且未要在 frontmatter 中显式指定 `slug` 时，URL 路径直接取自文件夹名称。若文件夹名为中文（如 `关于产品的思考`），URL 会被编码且不美观。应始终使用英文 kebab-case 命名文件夹（如 `2025-year-end-review`）以生成干净的 URL，中文标题保留在 frontmatter `title` 字段中即可。
- [2025-12-29] **Cloudflare Pages 与 Astro 后端集成**:
  1. **混合渲染 (Hybrid Mode)**: 使用 `@astrojs/cloudflare` 适配器时，将 `output` 设置为 `'hybrid'` 是最佳实践。这允许绝大部分博客内容作为边缘缓存的静态页面运行，而仅将特定的 API 端点（如 `/api/like`）标记为 `export const prerender = false` 以实现动态交互。
  2. **KV 绑定访问**: 在 Astro API 路由中访问 Cloudflare KV 命名空间，必须通过 `locals.runtime.env`（需在 `env.d.ts` 或类型断言中处理）。同时，必须在 Cloudflare Pages 面板的“设置 -> 函数 -> KV 命名空间绑定”中手动添加对应变量名（如 `BLOG_LIKES`），仅在代码中定义是不够的。

- [2025-12-29] **交互体验的“乐观更新”策略**: 在实现点赞计数等社交互动功能时，客户端脚本应采用“乐观更新”：点击按钮后立即在 UI 上增加数值并改变样式，同时异步发送网络请求。如果请求成功，则根据服务器返回的真实数据进行微调；如果失败，则静默处理或回滚。这种策略能消除网络延迟感，让 UI 响应瞬间完成。

- [2025-12-29] **UI 样式的一致性与重心**: 居中设计的圆形按钮（如点赞/关注）往往带有强烈的“号召性 (Call to Action)”，适合放在内容结束后的视觉中心。在实施此类设计时，应移除多余的文字引导，利用图标的语义、颜色填充和缩放动画（Heartbeat/Pop）来传达交互成功的信息，保持界面的极简与高级感。

- [2025-12-30] **杂志感 CSS 排版原则**: 为了打造“人文杂志感”（如 New Yorker 风格），核心在于：1. 极窄的内容容器（mac-width: 600px），这比通常的 800px 更有书卷气；2. 显着的垂直韵律调整（Vertical Rhythm），通过加大标题字号（2.5rem+）与正文的留白（margin-bottom: 60px+）来营造呼吸感；3. 装饰性细节的克制使用，如细分割线（divider line）来区隔信息层级，能在理性（Minimalist）与感性（Humanistic）之间取得平衡。


- [2025-12-30] **CSS Blur Clipping Artifacts**: When using large, absolute-positioned elements with `blur` filters for background decoration, ensure their parent container does not have `overflow: hidden` (or similar clipping context) at the exact edge where the blurred element sits. This clipping causes the soft blur to abruptly cut off, often appearing as a "square block" or graphical glitch. Solution: Move the overflow constraint higher up the DOM or ensure decorative elements are fully contained/inset.

- [2025-12-30] **Astro Script TypeScript Strictness**: When writing client-side scripts in Astro components (inside `<script>` tags), TypeScript strict mode is often enabled by default. Always add null checks (e.g., `if (element)`) or optional chaining when using `querySelector` or `getElementById`, as these can return null. Direct property access (like `.innerHTML`) on a potentially null result will cause build failures.

- [2025-12-30] **社交媒体内容提取的自适应策略**: 在使用 `browser_subagent` 提取社交媒体（如即刻）内容时，由于 DOM 结构和类名可能动态变化或混淆，更稳健的方法是使用 JavaScript `find` 结合内容关键词或正则表达式来定位目标元素，而非仅依赖 CSS 选择器。例如，通过 `document.querySelectorAll` 查找包含特定文本片段的元素，并配合图片的筛选逻辑，可以显著提高自动化提取的成功率。


- [2026-01-04] **Content Collection 目录结构规范**: 为了保持博客项目的长期可维护性，建议为每篇博客文章创建一个独立的子目录（如 `src/content/posts/my-post/index.md`），而不是直接在根目录创建 Markdown 文件。这种结构天然支持该文章独享的图片等静态资源（Asset Colocation），避免 `public` 或根目录图片文件夹的混乱。

- [2026-01-05] **脚本化内容格式强制**: 在自动化导入流程（如 Markdown 导入脚本）中，应在内容写入前进行格式清理。例如，为了避免 Frontmatter 标题与正文 H1 标题重复显示，应在脚本逻辑中自动识别并移除正文首行的 H1 标题。这比单纯依赖 CSS 隐藏更为彻底，且能保持数据的语义纯净。

- [2026-01-08] **模仿杂志风格的高级排版 (Premium Editorial Typography)**: 当追求类似 Not Boring 的"高级杂志感"阅读体验时，关键指标不仅仅是字体，更是布局参数：1. 内容容器宽度约为 728px；2. 基本字号提升至 19px；3. Line-height 设为 1.6。这组参数创造了最佳的每行字符数（Measure）和垂直韵律（Vertical Rhythm）。

- [2026-01-14] **HTML ID 生成的安全规范**: 在使用 `document.getElementById()` 或 CSS 选择器定位元素时，ID 必须避免包含特殊字符（如中文、冒号、空格）。格式化的日期字符串（如 `2026年1月13日-23:07`）会导致选择器失效。此外，时间戳作为 ID 也可能在同一秒内创建的多条记录间重复。最可靠的方案是使用 `crypto.randomUUID()` 生成真正唯一且选择器安全的标识符。
